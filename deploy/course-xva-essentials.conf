<VirtualHost *:443>
    ServerName www.course-xva-essentials.tglauner.com
    ServerAlias course-xva-essentials.tglauner.com
    ServerAdmin glaunertim@gmail.com

    DocumentRoot /var/www/html/course_xva_essentials/frontend/dist

    <Directory "/var/www/html/course_xva_essentials/frontend/dist">
        AllowOverride All
        Require all granted
        Options -Indexes
        RewriteEngine On
        RewriteCond %{REQUEST_FILENAME} -f [OR]
        RewriteCond %{REQUEST_FILENAME} -d
        RewriteRule ^ - [L]
        RewriteRule ^ /index.html [L]
        FallbackResource index.html
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined

    Include /etc/letsencrypt/options-ssl-apache.conf
    SSLCertificateFile /etc/letsencrypt/live/course-xva-essentials.tglauner.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/course-xva-essentials.tglauner.com/privkey.pem
    
    # Setup for tracking
    ProxyPreserveHost On
    ProxyPass        /collect  http://127.0.0.1:9000/collect
    ProxyPassReverse /collect  http://127.0.0.1:9000/collect
    ProxyPass        /api/     http://127.0.0.1:9000/api/
    ProxyPassReverse /api/     http://127.0.0.1:9000/api/

    # Serve dashboard SPA assets
    Alias /visitor_log/ "/var/www/html/visitor_log/"
    <Directory "/var/www/html/visitor_log/">
    Require all granted
    Options -Indexes
    </Directory>

    # Serve tracking bundle directly (no SPA rewrite)
    Alias /js/tracking.js "/var/www/html/visitor_analytics/tracking/tracking.js"
    Alias /visitor_analytics/tracking/ "/var/www/html/visitor_analytics/tracking/"
    <Directory "/var/www/html/visitor_analytics/tracking/">
    Require all granted
    Options -Indexes
    </Directory>

    # Keep SPA fallback for dashboard routes
    RewriteEngine On
    RewriteCond %{REQUEST_URI} ^/visitor_log/
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^visitor_log/ /visitor_log/index.html [L]
</VirtualHost>
